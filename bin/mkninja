#!/usr/bin/env python3

from pathlib import Path

import os
import sys
import platform

import yaml


def get_arch(x: str) -> dict | None:
    match x:
        case "x86_64" | "amd64":
            return {"n": "x86_64", "dn": "amd64"}
        case "x86" | "386" | "i386":
            return {"n": "x86", "dn": "i386"}
        case "aarch64" | "arm64" | "armv8":
            return {"n": "aarch64", "dn": "arm64"}
        case "armv7" | "arm/v7":
            return {"n": "armv7", "dn": "armv7"}
        case "armhf" | "arm/v6" | "armv6":
            return {"n": "armhf", "dn": "armv6"}
        case "loongarch64" | "loong64":
            return {"n": "loongarch64", "dn": "loong64"}
        case "ppc64le":
            return {"n": "ppc64le", "dn": "ppc64le"}
        case "riscv64":
            return {"n": "riscv64", "dn": "riscv64"}
        case "s390x":
            return {"n": "s390x", "dn": "s390x"}
        case _:
            return None


def get_packages() -> dict:
    packages = {}
    for package in Path("packages").glob("*.yaml"):
        with open(package.absolute(), "r") as f:
            data = yaml.safe_load(f)

        name = data["package"]["name"]
        version = data["package"]["version"]
        release = data["package"]["epoch"]

        dependencies = []
        if (
            "environment" in data
            and "contents" in data["environment"]
            and "packages" in data["environment"]["contents"]
        ):
            for d in data["environment"]["contents"]["packages"]:
                if d.endswith("@local"):
                    dependencies.append(d.removesuffix("@local"))
        if (
            "dependencies" in data["package"]
            and "runtime" in data["package"]["dependencies"]
        ):
            for d in data["package"]["dependencies"]["runtime"]:
                if d.endswith("@local"):
                    dependencies.append(d.removesuffix("@local"))

        packages[name] = {
            "d": dependencies,
            "r": release,
            "v": version,
        }
    return packages


def get_images(packages: dict) -> dict:
    images = {}
    for image in Path("images").glob("*.yaml"):
        with open(image.absolute(), "r") as f:
            data = yaml.safe_load(f)

        name = data["annotations"]["org.opencontainers.image.title"]
        tag = packages[data["annotations"]["dev.chainguard.package.main"]]["v"]

        dependencies = []
        for d in data["contents"]["packages"]:
            if d.endswith("@local"):
                dependencies.append(d.removesuffix("@local"))

        images[image.stem] = {
            "d": dependencies,
            "n": name,
            "t": tag,
        }
    return images


def main():
    packages = get_packages()
    images = get_images(packages)

    arches = []
    if "ARCH" in os.environ:
        for x in os.environ["ARCH"].split(","):
            if arch := get_arch(x):
                arches.append(arch)
    else:
        arches = [get_arch(platform.machine())]

    defaults = {
        "alpine_branch": "edge",
        "ocirepo": "apko.local",
        "melange": "cgr.dev/chainguard/melange",
        "apko": "cgr.dev/chainguard/apko",
        "melange_flags": "",
        "apko_flags": "",
        "melange_cachedir": "./cache/melange",
        "apk_cachedir": "./cache/melange",
        "packages_outdir": "./out/pkg",
        "workdir": os.getcwd(),
    }

    for k, v in defaults.items():
        sys.stdout.write(f"{k} = {os.environ.get(k.upper(), v)}\n")

    sys.stdout.write("\n")

    sys.stdout.write(
        "rule melange-build\n"
        + "  command = docker run --rm --privileged --name melange --hostname melange --network host"
        + " -v '${melange_cachedir}':/cache/melange"
        + " -v '${apk_cachedir}':/cache/apk"
        + " -v '${packages_outdir}':/packages"
        + " -v '${workdir}':/work"
        + " $melange build /work/'${in}'"
        + " --arch '${arch}'"
        + " --source-dir /work/packages/'${package}'"
        + " --pipeline-dir /work/pipelines"
        + " --cache-dir /cache/melange"
        + " --apk-cache-dir /cache/apk"
        + " --out-dir /packages"
        + " --signing-key /work/local.rsa"
        + " --repository-append 'https://dl-cdn.alpinelinux.org/alpine/${alpine_branch}/main'"
        + " --repository-append 'https://dl-cdn.alpinelinux.org/alpine/${alpine_branch}/community'"
        + " --package-append alpine-release ${melange_flags}"
        + "\n"
    )

    sys.stdout.write("\n")

    sys.stdout.write(
        "rule apko-publish\n"
        + "  command = docker run --rm --name apko --hostname apko --network host"
        + " -v /var/run/docker.sock:/var/run/docker.sock"
        + " -v ~/.docker:/root/.docker"
        + " -v '${melange_cachedir}':/cache/melange"
        + " -v '${apk_cachedir}':/cache/apk"
        + " -v '${packages_outdir}':/packages"
        + " -v '${workdir}':/work"
        + " $apko publish /work/'${in}' '${ocirepo}/${name}:${tag}-${archdn}'"
        + " --arch '${arch}'"
        + " --cache-dir /cache/apk"
        + " --keyring-append /work/local.rsa.pub"
        + " --repository-append '@local /packages'"
        + " --repository-append 'https://dl-cdn.alpinelinux.org/alpine/${alpine_branch}/main'"
        + " --repository-append 'https://dl-cdn.alpinelinux.org/alpine/${alpine_branch}/community'"
        + " --package-append alpine-release ${apko_flags} | tee 'digest+${name}+${tag}+${archdn}'"
        + "\n"
    )

    sys.stdout.write("\n")

    for arch in arches:
        archn = arch["n"]
        archdn = arch["dn"]

        for package in packages:
            version = packages[package]["v"]
            release = packages[package]["r"]

            sys.stdout.write(
                f"build $packages_outdir/{archn}/{package}-{version}-r{release}.apk: melange-build packages/{package}.yaml"
            )

            if len(packages[package]["d"]) > 0:
                sys.stdout.write(" ||")
                for d in packages[package]["d"]:
                    sys.stdout.write(f" pkg-{d}-{archdn}")

            sys.stdout.write("\n" + f"  arch = {archn}\n" + f"  package = {package}\n")

            sys.stdout.write(
                f"build pkg-{package}-{archdn}: phony $packages_outdir/{archn}/{package}-{version}-r{release}.apk\n"
            )

            sys.stdout.write("\n")

        for image in images:
            name = images[image]["n"]
            tag = images[image]["t"]

            sys.stdout.write(
                f"build digest+{name}+{tag}+{archdn}: apko-publish images/{image}.yaml"
            )

            if len(images[image]["d"]) > 0:
                sys.stdout.write(" ||")
                for d in images[image]["d"]:
                    sys.stdout.write(f" pkg-{d}-{archdn}")

            sys.stdout.write(
                "\n"
                + f"  arch = {archn}\n"
                + f"  archdn = {archdn}\n"
                + f"  name = {name}\n"
                + f"  tag = {tag}\n"
            )

            sys.stdout.write(
                f"build publish-{image}-{archdn}: phony digest+{name}+{tag}+{archdn}\n"
            )

            sys.stdout.write("\n")


if __name__ == "__main__":
    main()
